<!DOCTYPE html>
<html lang="en">

<head>
	<title>Block party!</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>

	<!-- javascript libraries -->
	<script src="js/libs/three.min.js"></script>
	<script src="js/libs/stats.min.js"></script>
	<script src="js/libs/ShaderParticles.min.js"></script>

	<script src="js/libs/Detector.js"></script>
	<script src="js/libs/ConvexGeometry.js"></script>
	<script src="js/libs/OrbitControls.js"></script>

	<!-- our own javascript objects -->
	<script src="js/Wall.js"></script>
	<script src="js/BlockGenerator.js"></script>
	<script src="js/Game.js"></script>
	<script src="js/RandomMode.js"></script>
	<script src="js/LevelMode.js"></script>
	<script src="js/TutorialMode.js"></script>
	<script src="js/Block.js"></script>
	<script src="js/Level.js"></script>

	<!-- other javascript functions -->
	<script src="js/controls.js"></script>
	<script src="js/gameUtils.js"></script>
	<script src="js/navigation.js"></script>

	<div id="reMenu" class="nav">
		<h1>Block Party</h1>
		<p id="info2">Game Over</p>
		<a href="javascript: void(0)" id="restart" onclick="reset()" >Restart</a> 
	</div>

	<div id="menu" class="nav">
		<h1>Block Party</h1>
		<a href="javascript: void(0)" class="menuItem" onclick="initGame('tutorial')" >Tutorial</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onclick="initGame('level')" >Level mode</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onclick="initGame('random')" >Random mode</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onClick="showElementAndHideNav(instructions_doc)">Instructions</a>
		<br>
	</div>	

	<div id="levelModeMenu" class="nav">
	</div>

	<div id="instructions" class="nav">
		<h1>Instructions</h1>
		<br>
		<a class="instructions">W,A,S,D = Move</a>
		<br>
		<a class="instructions">1,2,3 = Rotate</a>
		<br>
		<a class="instructions">SPACE = Place block</a>
		<br>
		<a class="instructions">R,F = Go up/down to next legal spot</a>
		<br>
		<a class="instructions">MOUSE WHEEL = Zoom</a>
		<br>
		<a class="instructions">LEFT CLICK and DRAG = Rotate camera</a>
		<br>
		<a class="instructions">RIGHT CLICK and DRAG = Pan camera</a>
		<br>
		<a class="instructions">SHIFT = Toggle bounding box</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onClick="showElementAndHideNav(menu_doc)">Back</a>
	</div>

	<div id="endScreen" class="nav">
	</div>

	<div id="pauseScreen" class="nav">
		<h1>Paused</h1>
		<br>
		<a href="javascript: void(0)" class="menuItem" onClick="resumeGame()">Resume</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onClick="restartLevel()">Restart</a>
		<br>
		<a href="javascript: void(0)" class="menuItem" onClick="backToMenu()">End Game</a>
	</div>

	<div id="selectBlockScreen" class="nav">
	</div>

    <div id="game">
	    <div id="info">
	    	<font color ="white">	    	
			    Volume: <span id ="volume_used">0</span>
			    <br>
			    Score: <span id="score">0</span>
			    <br>			    
			    <span id="timer">0:00</span>
			    <br>
			    Pieces left: <span id="piecesLeft">0</span>
			    <br>
			    <span id="showNextPiece">Next piece: <span id="nextPiece"></span><br/></span>
			    <button id="avail_blocks" onclick="game.showAvailable()">Switch block</button>
				<br>
			</font>
	    </div>
	    <span id="hint"></span>
	    <span id="center_tooltip"></span>
    </div>

    <div id="loading" class="nav">
    	<p id="loading_text">Loading...</p>
    </div>

    <audio id="main_music" loop>
    	<!-- <source src="https://dl.dropboxusercontent.com/u/87553861/spaceForest.mp3" type="audio/mp3" /> -->
    	<source src="http://whateverwhouare.github.io/block_party/sounds/spaceForest.mp3" type="audio/mp3">
		<!-- <source src="sounds/spaceForest.mp3" type="audio/mp3" /> -->
	</audio>

    <audio id="success_sound">
    	<source src="sounds/ahh.mp3" type="audio/mp3" />
	</audio>

    <audio id="fail_sound">
    	<source src="sounds/aww.mp3" type="audio/mp3" />
	</audio>

    <audio id="ding_sound">
    	<source src="sounds/ding.mp3" type="audio/mp3" />
	</audio>

	<script>

		if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

		var container, stats;
		var camera, scene, renderer, projector;
		var mouse2D, mouse3D;
		var cameraInitPos = new THREE.Vector3(5, 325, 694);
		var cameraInitRotation = new THREE.Euler(-0.4379673247787578, 0.00652451553634967, 0.00305539757043725, "XYZ");

		var theta = 45 * 0.5;
		var blockNoise = new Audio("sounds/wood-cracking-1.wav");
		var collisionNoise = new Audio("sounds/beep-03.mp3");
		var successSound = document.getElementById("success_sound");
		var failSound = document.getElementById("fail_sound");
		var dingSound = document.getElementById("ding_sound");

		var rollOverMesh;
		var floor;
		var i, intersector;
		var gameBoardOrientation;
		var controls;
		var time = Date.now();

		var timer = document.getElementById( 'timer');
		var volume_doc = document.getElementById( 'volume_used' );
		var blocker = document.getElementById("blocker");
		var nextPiece_doc = document.getElementById( 'nextPiece' );
		var showNextPiece_doc = document.getElementById( 'showNextPiece' );
		var avail_blocks = document.getElementById("avail_blocks");
		var score_doc = document.getElementById("score");
		var menu_doc = document.getElementById("menu");
		var reMenu_doc = document.getElementById("reMenu");
		var endScreen_doc = document.getElementById("endScreen");
		var instructions_doc = document.getElementById("instructions");
		var pauseScreen_doc = document.getElementById("pauseScreen");
		var levelModeMenu_doc = document.getElementById("levelModeMenu");
		var hint_doc = document.getElementById("hint");
		var center_tooltip_doc = document.getElementById("center_tooltip");
		var selectBlockScreen_doc = document.getElementById("selectBlockScreen");
		var piecesLeft_doc = document.getElementById("piecesLeft");
		var loading_doc = document.getElementById("loading");
		var nav_items = [menu_doc, reMenu_doc, endScreen_doc, instructions_doc, pauseScreen_doc, levelModeMenu_doc,
			selectBlockScreen_doc, loading_doc];
		var info_items = [showNextPiece_doc, hint_doc, avail_blocks, center_tooltip_doc];

		var backToMenu_string = '<a href="javascript: void(0)" class="menuItem" onClick="backToMenu()">Back</a>';


		var STEP_SIZE = 50;
		var ALIVE_TIME = 100 * 1000.0;	// time during which the block is alive, in milliseconds
		var FLOOR_SIZE = 1000;
		var FLOOR_SIZE_HALF = FLOOR_SIZE / 2;
		var INIT_OPACITY = 0.7;

		var pos_illegal_code = 0;

		var timeRemaining, mins, secs;

		// Load the background texture
        var texture = THREE.ImageUtils.loadTexture( 'textures/space2.jpg' );
        var colorAgainstTexture = 0xffffff;
        var floor
        // variables for the background images
        var backgroundMesh;
        var backgroundScene;
        var backgroundCamera;
        var backgroundRatio = 1440 / 900;

        var gameInProgress = false;
        var nextPiece = "";
        var toCheckGoal = false;

        // Used in initParticles()
		var emitter, particleGroup;

		var projector = new THREE.Projector();
		var raycaster = new THREE.Raycaster();		
		var INTERSECTED = null;

		var game;

		var mainMusic;

		mainMusic = document.getElementById("main_music");
		if (canPlayAudio(mainMusic)) {
			mainMusic.addEventListener("loadeddata", function() {
				showElementAndHideNav(menu_doc);
			});
			showElementAndHideNav(loading_doc);			
		} else {
			mainMusic = null;
			showElementAndHideNav(menu_doc);
		}

		init();
		initParticles();
		animate();

		function init() {
			container = document.getElementById( 'game' );
			document.body.appendChild( container );



			// initializes values for backgroud image
			// width must be image_width / image_height to perserve ratio
			var background_scale = 100;
			backgroundMesh = new THREE.Mesh(
            	new THREE.PlaneGeometry(backgroundRatio * background_scale, background_scale, 0),	
            	new THREE.MeshBasicMaterial({map: texture}));
			backgroundMesh.position.set(0, 0, -background_scale);	// must set z to negative because the normal is (0, 0, 1)
        	backgroundMesh.material.depthTest = false;
        	backgroundMesh.material.depthWrite = false;

        	// Create your background scene
        	backgroundScene = new THREE.Scene();
        	backgroundCamera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
        	backgroundScene.add( backgroundCamera );
        	backgroundScene.add( backgroundMesh );
        	backgroundCamera.lookAt(backgroundMesh.position);

			camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
            // camera.position.x = 5;
            // camera.position.y = 325;
            // camera.position.z = 694;

			scene = new THREE.Scene();
			renderer = new THREE.WebGLRenderer( { antialias: true } );
			// renderer.setClearColor(0xFFFFFF,0);
			renderer.setClearColor(0x000000,0);
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.shadowMapEnabled = true;

			controls = new THREE.OrbitControls( camera );
			controls.rotateSpeed = 0.5;
			controls.minPolarAngle = 0.0;
			controls.maxPolarAngle = Math.PI * 4 / 9;
			controls.noKeys = true;
			scene.add( controls );

			// picking
			mouse2D = new THREE.Vector3( 0, 10000, 0.5 );

			// basic scene
			floor = new Wall(FLOOR_SIZE);
			floor.plane.receiveShadow = true;
			floor.addToScene(scene);

			// placeholder so there's no error
			rollOverMesh = new THREE.Mesh();

			// Lights
			var ambientLight = new THREE.AmbientLight( 0x3c3c3c );
			scene.add( ambientLight );

			var directionalLight = new THREE.DirectionalLight( 0xffffff );
			directionalLight.position.set( 1, 0.75, 0.5 ).normalize();
			directionalLight.intensity = 0.8;
			scene.add( directionalLight );

			directionalLight = new THREE.DirectionalLight( 0xffffff );
			directionalLight.position.set( -1, 0.75, -0.5 ).normalize();
			directionalLight.intensity = 0.8;
			scene.add( directionalLight );

			var shadowLight = new THREE.DirectionalLight( 0xffffff );
			shadowLight.position.set( 0, 1, 0 ).normalize();
			shadowLight.castShadow = true;
			shadowLight.shadowCameraNear = -1000;
			shadowLight.shadowCameraFar = 10;
			shadowLight.onlyShadow = true;
			scene.add( shadowLight );

			container.appendChild( renderer.domElement );

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.bottom = '0px';
			container.appendChild( stats.domElement );

			document.addEventListener( 'mousedown', onDocumentMouseDown, false );
			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			document.addEventListener( 'keydown', onDocumentKeyDown, false );
			document.addEventListener( 'keyup', onDocumentKeyUp, false );
			window.addEventListener( 'resize', onWindowResize, false );

		}

        // Create particle group and emitter
        function initParticles() {
        	particleGroup = new SPE.Group({
        		texture: THREE.ImageUtils.loadTexture('./textures/star2.png'),
        		maxAge: 2,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                depthTest: false
        	});

        	emitter = new SPE.Emitter({
        		positionSpread: new THREE.Vector3(1000, 1000, 1000),

                acceleration: new THREE.Vector3(0, 0, 10),

        		velocity: new THREE.Vector3(0, 0, 10),

        		colorStart: new THREE.Color('white'),
        		colorEnd: new THREE.Color('white'),
        		sizeStart: 35,
        		sizeEnd: 35,
                opacityStart: 0,
                opacityMiddle: .5,
                opacityEnd: 0,

        		particleCount: 10000
        	});

        	particleGroup.addEmitter( emitter );
        	scene.add( particleGroup.mesh );
        }		

		function animate() {
			requestAnimationFrame( animate );
			controls.update();
			render(0.016);
			stats.update();
		}


		function render(dt) {
			particleGroup.tick( dt );

			renderer.autoClear = false;
			renderer.clear();
			renderer.render( backgroundScene , backgroundCamera );
			renderer.render( scene, camera );

			calculateGameBoardOrientation();

			if (gameInProgress) {
				if (game.currentAliveTime < ALIVE_TIME) {
					// update time
					timeRemaining = Math.max(ALIVE_TIME - game.currentAliveTime, 0);
					secs = Math.floor(timeRemaining / 1000.0);
					mins = Math.floor(secs / 60);
					timer.innerHTML = ("0" + mins).slice(-2) + ":" + ("0" + secs).slice(-2);

					// update opacity
					rollOverMesh.material.opacity = INIT_OPACITY + game.currentAliveTime / ALIVE_TIME * (1 - INIT_OPACITY);
				} else {
					add_voxel();
				}				

				game.currentAliveTime += Date.now() - time;

				intersectToHighlight();
			}

			if (game) {
				if (game.showingPreview) {
					game.findIntersected();
					renderer.clear( false, true, false );
					renderer.render( game.previewScene, game.previewCamera );
				}				
			}

			time = Date.now();
		}

	</script>

</body>


</html>
